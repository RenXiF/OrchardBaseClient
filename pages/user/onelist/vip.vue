<template>
	<view class="flex_columns u-p-20">
		<view class="vip_one  flex_center" :style="{'background-image':'url('+viplist[0]+');'}"
			style="background-color: ;">
			<view class="flex_rows flex_center u-m-l-20">
				<u-avatar :src="userlist.userImg?userlist.userImg : src" size="large"></u-avatar>
				<view class="u-m-l-20 flex_columns flex_center">
					<text class="ft-wh u-font-lg u-m-b-10">{{userlist.userName ? userlist.userName : '未登录'}}</text>
					<text class="u-font-md  u-type-warning-disabled"
						v-if="userlist.userRole">{{userlist.userRole}}</text>
				</view>
			</view>
		</view>
		<view class="vip_two">
			<u-grid :col="4" :border="false" align="center">
				<u-grid-item v-for="(item ,index) in sortlist" :key="index" class=""
					@click="doUrlck(item.http,item)">
					<view class="u-p-20 flex_jufy_center flex_columns"
						:style="{'border-radius':'15rpx','margin': '15rpx','background-color': item.bgcolor}">
						<u-icon :name="item.logo?item.logo:'/static/index/menu1.png'" size="60"
							:custom-style="{'border-radius':'30px'}" imgMode="scaleToFil" :color="item.color"></u-icon>
						<view class="grid-text ellipsis">{{item.dictionaryValue}}</view>
					</view>
				</u-grid-item>
			</u-grid>
		</view>
		<view class="vip_three">
			<text class="u-font-xl">优惠券</text>
			<view class="flex_columns">
				<coupon v-for="(item, index) in EntityList" :key="index" @couponCk="couponCk" types='2132'
					v-bind:item="item" theme="#ff6c00" color="#f8f8f8" solid="#ff6c00"></coupon>
			</view>
		</view>
		<!-- 弹出框 -->
		<u-popup v-model="show" mode="bottom" length="600" safe-area-inset-bottom @open="openPOP()" @close="closePOP()"
			closeable safe-area-inset-bottom>
			<view class="flex_columns u-p-20" v-if="popupli">
				<view class="flex_jufy_center u-font-lg">
					<text>VIP选择</text>
				</view>
				<view class="u-p-20 u-m-t-30">
					<slide :list="vipli" @ckindex="clickin" ></slide>
				</view>
				<view class=" u-p-10 u-m-t-30">
					<u-button :ripple="true" type="warning" @click="cartadd()" :disabled="!vipli?true:false">立即开通</u-button>
				</view>
			</view>
		</u-popup>
	</view>
</template>

<script>
	import coupon from '@/components/coolc-coupon/coolc-coupon'; //优惠券组件
	import slide from '@/components/slide/index.vue'; //优惠券组件
	export default {
		components: {
			coupon,
			slide
		},
		data() {
			return {
				show: false,//弹窗控制
				vipshow:false,//是否选择
				vipitem:{},//已选择vip
				vipTreatment:0,
				viptli:{},
				vipli:[],
				yuanlist:[],//原数据
				src: '/static/logo.png',
				viplist: ['/static/vip/v1.png', '/static/vip/v2.png', '/static/vip/v3.png'],
				sortlist: [{
						dictionaryValue: '我的优惠券',
						logo: 'coupon',
						color: '#FE0000',
						bgcolor: '#EAECF8',
						http:'pages/user/onelist/myCoupon'
					},
					{
						dictionaryValue: '开通VIP',
						logo: 'level',
						color: '#FFC600',
						bgcolor: '#FFF0D9',
						http:'pages/user/onelist/openvip'
					},
					{
						dictionaryValue: '开通记录',
						logo: 'order',
						color: '#ffaaff',
						bgcolor: '#FFF0D9',
						http:'pages/user/onelist/open_vip'
					},
				], //分类数据
				popupli:[],
				EntityList:[],//优惠卷数据
				userlist: {},
			}
		},
		onLoad() {
			
		},
		onShow() {
			if (this.utils.isLogin()) {
				this.userlist = uni.getStorageSync('userlist');
				console.log(this.userlist)
				this.getdiscount()
				this.getviplist()
			}
		},
		methods: {
			//获取优惠券
			getdiscount() {
				this.http.getApi('discount/list', {}, 'post').then(res => {
					console.log(res);
					this.EntityList = res.list;
					uni.hideLoading();
				}).catch(err => {
					console.log(err);
					this.utils.error(err.msg);
					uni.hideLoading();
				});
			},
			doUrlck(http,item){
				if (item.dictionaryValue==='开通VIP') {
					this.show = true
				} else{
					this.doUrl(http,item)
				}
			},
			closePOP() { //关闭弹窗
				// console.log(this.popupli);
			},
			openPOP() { //打开弹窗
				// console.log(this.popupli);
			},
			//点击滑动块
			clickin(index){
				this.vipshow = true
				this.vipitem = this.vipli[index]
				this.vipli[index].show = true;
				this.vipli.map((val, idx) => {
					if (index != idx) this.vipli[idx].show = false;
				})
			},
			//点击确认开通
			cartadd(){
				if(!this.vipshow){
					this.utils.error('请先选择需要开通的vip')
					return
				}
				var it = {
					grade: this.vipitem.tit,
					money: this.vipitem.price,
					originalPrice:0,
					userId: this.userlist.id
				}
				// console.log(it);
				for(let i=0;i<this.yuanlist.length;i++){
					if(it.grade == this.yuanlist[i].vipName){
						it.originalPrice = this.yuanlist[i].price
					}
				}
				this.orderfound(it)
			},
			 //开通vip订单
			orderfound(jsonData) {
				console.log(jsonData);
				this.utils.showloading('正在加载数据.....');
				this.http.getApi('vipor/save', jsonData, 'post').then(res => {
					console.log(res);
					this.verificationLogin(res)
				}).catch(err => {
					console.log(err);
					uni.hideLoading();
					this.utils.error(err.message);
				});
			},
			//获取openid
			verificationLogin(item) {
				var _this = this;
				uni.login({
					provider: 'weixin',
					success: function(loginRes) {
						console.log(loginRes);
						// _this.opengid(loginRes.code);
						_this.utils.getOpenId(loginRes.code,(res)=>{
							console.log(res);
							_this.wxPayorder(item,res.openid)
						})
					}
				});
			},
			 //支付订单
			wxPayorder(item,openid) {
				let li = {
					orderNo: item.order,
					amount: 0.01,
					// amount: item.money,
					body: 'vip开通',
					openid: openid
				}
				console.log(li);
				this.http.getApi('wxPay/unifiedOrder', li, 'get').then(res => {
					console.log(res);
					console.log('执行支付');
					this.paymentorder(res.data);
				}).catch(err => {
					console.log(err);
					uni.hideLoading();
					this.utils.error(err.msg);
				});
			},
			//拉起支付
			paymentorder(data) {
				console.log(data);
				var _this = this;
				_this.utils.showloading('正在支付');
				uni.requestPayment({
					provider: 'wxpay',
					orderInfo: data, //微信、支付宝订单数据
					// #ifdef MP-WEIXIN 
					timeStamp: data.timeStamp,
					nonceStr: data.nonceStr,
					package: data.package,
					signType: data.signType,
					paySign: data.paySign,
					// #endif
					success: function(res) {
						console.log(res);
						// uni.hideLoading();
						_this.utils.success('支付成功！', () => {
							// _this.utils.navback();
							_this.utils.showloading('刷新中...')
							_this.utils.refLogin()
							setTimeout(function() {
								_this.userlist = uni.getStorageSync('userlist');
								_this.getviplist()
								console.log(_this.userlist);
							}, 500)
							_this.show = false
						});
					},
					fail: function(err) {
						console.log(err);
						uni.hideLoading();
						_this.utils.error('您已取消支付！', () => {
							_this.show = false
						});
					}
				});
			},
			//点击优惠券
			couponCk(item) {
				console.log(item);
				let li = {
					commodityId: item.commodityId,
					discountId: item.id,
					userId: this.userlist.id
				}
				console.log(li);
				this.http.getApi('oyhj/receive', li, 'post').then(res => {
					console.log(res);
					this.utils.success(res.message);
					// uni.hideLoading();
				}).catch(err => {
					console.log(err);
					this.utils.error(err.message);
					uni.hideLoading();
				});
			},
			//获取vip
			getviplist() {
				this.http.getApi('vip/list',{}, 'post').then(res => {
					console.log(res);
					this.yuanlist = JSON.parse(JSON.stringify(res.list));
					this.guolvvipt(res.list)
					if (this.vipTreatment == 0) {
						this.vipli =  res.list.map(item =>{
							return {
								id: item.id,
								tit: item.vipName,
								price: item.price,
								yprice: item.vipTreatment,
								show:false
							}
						});
					} else{
						let it = this.guolvvip(res.list)
						console.log(this.viptli);
						this.vipli = it.map(item =>{
							if(this.viptli.vipTreatment){
								item.price = item.price - this.viptli.price
							}
							return {
								id: item.id,
								tit: item.vipName,
								price: item.price,
								yprice: item.vipTreatment,
								show:false
							}
						});
					}
					
					console.log(this.vipli);
					
					uni.hideLoading();
				}).catch(err => {
					console.log(err);
					this.utils.error(err.msg);
					uni.hideLoading();
				});
			},
			//过滤折扣
			guolvvipt(li){
				for(let i=0;i<li.length;i++){
					if(this.userlist.userRole ==li[i].vipName){
						this.vipTreatment = li[i].vipTreatment
						this.viptli = li[i]
					}
				}
				// console.log(this.viptli);
			},
			//过滤vip
			guolvvip(li){
				// console.log(this.vipTreatment);
				let vipli = []
				for(let i=0;i<li.length;i++){
					if( li[i].vipTreatment < this.vipTreatment && this.vipTreatment != 0){
						vipli.splice(0,0,li[i])
					}
				}
				return vipli
			},
			
		}
	}
</script>

<style lang="scss">
	.vip_one {
		width: 100%;
		padding: 20rpx;
		min-height: 350rpx;
		background-repeat: no-repeat;
		background-size: 100%;
		// margin: 30rpx;
	}
</style>
