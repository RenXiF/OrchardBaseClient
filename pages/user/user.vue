<template>
	<!-- 用户中心 -->
	<view class="flex_columns">
		<view class="bg_three"></view>
		<view class="u-p-30">
			<view class="flex_columns bg_radius box_shadow one_ck">
				<view class="flex_between flex_center u-p-20">
					<!-- <view class="flex_center flex_rows">
						<u-avatar :src="wxlist.avatarUrl?wxlist.avatarUrl : src" size="large"></u-avatar>
						<text class="ft-wh u-m-l-20">{{wxlist.nickName ? wxlist.nickName : '未登录'}}</text>
					</view> -->
					<view class="flex_center flex_rows">
						<u-avatar :src="userlist.userImg?userlist.userImg : src" size="large"></u-avatar>
						<view class="u-m-l-20 flex_columns">
							<text class="ft-wh u-font-lg u-m-b-10">{{userlist.userName ? userlist.userName : '未登录'}}</text>
							<text class="u-font-md  u-type-warning-disabled" v-if="userlist.userRole">{{userlist.userRole}}</text>
						</view>
					</view>
					<view class="flex_center">
						<button class="bg-gradual-red" size="mini" @click="exitLogin" v-if="lognum == 1">退出登录</button>
						<button class="bg-gradual-red" size="mini" @click="appLoginWx" v-if="lognum == 0">登录</button>
					</view>
				</view>
			</view>

			<view class="bg_radius box_shadow u-m-t-30 u-p-20 flex_columns">
				<view class="flex_between flex_center" @click="doUrl('pages/user/order/order')">
					<text class="u-font-md u-main-color">我的订单</text>
					<!-- <text class="u-font-xs u-border-color">全部订单</text> -->
				</view>
				<view class="">
					<u-grid :col="4" :border="false">
						<u-grid-item v-for="(item ,index) in menulist" :key="index"
							@click="doUrl(item.http,{index:index})">
							<u-icon :name="item.icon" :size="46" color="#ef654d"></u-icon>
							<view class="grid-text">{{item.title}}</view>
						</u-grid-item>
					</u-grid>
				</view>
			</view>
			<view class="bg_radius box_shadow u-m-t-30 u-p-10 flex_columns">
				<u-grid :col="3" :border="false">
					<u-grid-item v-for="(item ,index) in menulist2" :key="index" @click="YZdoUrl(item)">
						<u-icon :name="item.icon" :size="46" color="#7c7c7c"></u-icon>
						<view class="grid-text">{{item.title}}</view>
					</u-grid-item>
				</u-grid>
			</view>
			<form @submit="handlePush" report-submit='false'>
			  <button formType="submit">推送消息</button>
			</form>
			<!-- <view class="boder">
				<text>打印：{{shareli}}</text>
			</view> -->
		</view>
	</view>
</template>

<script>
	import mixin from '@/common/form-id-mixins.js'
	export default {
		mixins: [mixin],
		data() {
			return {
				lognum: 0,
				src: '/static/logo.png',
				menulist: [{
						title: '待付款',
						icon: 'photo',
						http: 'pages/user/order/order'
					},
					{
						title: '待发货',
						icon: 'lock',
						http: 'pages/user/order/order'
					},
					{
						title: '待收货',
						icon: 'hourglass',
						http: 'pages/user/order/order'
					},
					{
						title: '待评价',
						icon: 'more-dot-fill',
						http: 'pages/user/order/order'
					}
				],
				menulist2: [{
						title: '收藏',
						icon: 'thumb-up',
						http: 'pages/user/onelist/Collection'
					},
					{
						title: '购物车',
						icon: 'shopping-cart',
						http: 'pages/user/onelist/Cart'
					},
					{
						title: '收货地址',
						icon: 'car',
						http: 'pages/address/ment_address'
					},
					{
						title: '会员中心',
						icon: 'level',
						http: 'pages/user/onelist/vip'
					},
					{
						title: '设置',
						icon: 'edit-pen',
						http: 'pages/user/onelist/userlist'
					},
					{
						title: '在线客服',
						icon: 'server-fill',
						http: 'no'
					},
					// {
					// 	title: '投诉建议',
					// 	icon: 'edit-pen',
					// 	http: 'pages/user/onelist/complaintList'
					// },
					{
						title: '关于我们',
						icon: 'setting',
						http: 'pages/user/onelist/aboutApp'
					}

				],
				wxlist: '',
				userlist: {},
				shareli: '',
				share: {
					title: '快来加入我们吧',
					path: '/pages/index/index',
					imageUrl: '',
					desc: '',
					content: ''
				},
				openId: '',

			}
		},
		onLoad() {},
		onShow() {
			if (this.utils.isLogin()) {
				this.userlist = uni.getStorageSync('userlist');
				if (this.userlist.id) {
					this.lognum = 1;
					this.openMsg()
				}
				console.log(this.userlist)
			}
			if (!this.userlist.id) {
				this.lognum = 0;
			}
		},
		onShareAppMessage(res) {
			console.log(res);
			if (res.from === 'button') { // 来自页面内分享按钮
				console.log(res);
				console.log(res.target);
				uni.setStorageSync('shareli', res.target);
			}
		},
		methods: {
			handlePush(e) {
				console.log(e);
			      this.getFormIdData(e.detail.formId)
			    },
			// 开启订阅消息
			openMsg() {
			    var that = this
			    // 获取用户的当前设置，判断是否点击了“总是保持以上，不在询问”
			    wx.getSetting({
			        withSubscriptions:true,  //是否获取用户订阅消息的订阅状态，默认false不返回
			       success(res) {
					   console.log(res)
			          if(res.authSetting['scope.subscribeMessage']) { //用户点击了“总是保持以上，不再询问”
			             uni.openSetting({ // 打开设置页
			               success(res) {
			                 console.log(res.authSetting)
			               }
			             });
			          }else { // 用户没有点击“总是保持以上，不再询问”则每次都会调起订阅消息
			             // var templateid = that.setting.templateid.map(item => item.tempid)
			             uni.requestSubscribeMessage({
			               tmplIds: ['6lF4LvrKBd3In2GpKHj7a5bpa4olZ9dGKSrDbBISOQU'],
			               success (res) {
			                  console.log(res)
							  console.log('1111111111')
			               },
			               fail:(err) => {
			                  console.log(err)
							  console.log('22222222')
			               }
			             }) 
			          }
			       }
			    })
			},
			exitLogin() {
				if (this.utils.logout()) {
					this.utils.success('退出成功！');
					this.lognum = 0;
					this.userlist = {};
					// this.openId = '';
					this.wxlist = '';
				}
			},
			appLoginWx() {
				this.doUrl('pages/user/login')
				// this.wxpay()
				// this.userUp();
				
				// this.verificationLogin();
				// var _this = this;
				// if (_this.wxlist != '') {
				// 	_this.verificationLogin();
				// } else {
				// 	uni.getUserProfile({
				// 		desc: '获取基本资料',
				// 		success: function(loginRes) {
				// 			console.log(loginRes);
				// 			_this.wxlist = loginRes.userInfo;
				// 			_this.verificationLogin();
				// 		},
				// 		fail: function(err) {
				// 			console.log(err);
				// 			_this.utils.error('请先同意授权')
				// 		}
				// 	});
				// }
			},
			wxpay(code){
				let uer = {
					amount: 0.01,
					body: '测试',
					orderNo: '4661316516',
					openid:code
				}
				console.log(uer);
				this.http.getApi('wxPay/unifiedOrder', uer, 'get').then(res => {
					console.log(res);
					this.payment(res.data)
					console.log('12313213213');
				}).catch(err => {
					console.log(err);
					uni.hideLoading();
				});
			},
			payment(data) {
				// console.log('执行');
				console.log(data);
				var _this = this;
				console.log('执行支付');
				uni.requestPayment({
					provider: 'wxpay',
					orderInfo: data, //微信、支付宝订单数据
					// #ifdef MP-WEIXIN 
					timeStamp: data.timeStamp,
					nonceStr: data.nonceStr,
					package: data.package,
					signType: data.signType,
					paySign: data.paySign,
					// #endif
					success: function(res) {
						console.log(res);
						_this.utils.success('支付成功！');
						// _this.payindex = 1;
						// _this.addBarrage(_this.order);
						// _this.utils.showloading('正在上传图片');
						// _this.utils.upimg(_this.upimg, (res) => {
						// 	console.log(res)
						// 	_this.order.imgAddress = res.data.url;
						// 	_this.addBarrage(_this.order);
						// });
					},
					fail: function(err) {
						// console.log('qqqqqqqqqq');
						console.log(data);
						console.log(err);
						_this.utils.error('您已取消支付！');
						uni.hideLoading();
					}
				});
			},
			panduan() {
				if (this.userlist.spareOne !== this.wxlist.avatarUrl && this.wxlist != '') {
					this.userUp();
				}
			},
			userUp() { //更新用户信息
				let uer = {
					userName: '东盗主',
					password: 'qa123456',
					// usrName: this.wxlist.nickName
				}
				console.log(uer);
				this.http.getApi('/user/login', uer, 'post').then(res => {
					console.log(res);
					console.log('12313213213');
				}).catch(err => {
					console.log(err);
					uni.hideLoading();
				});
			},
			//验证登录状态
			verificationLogin() {
				// this.utils.showloading();
				this.lognum = 1;
				var _this = this;
				if (this.openId != '' && this.openId != undefined) {
					this.userLogin();
				} else {
					uni.login({
						provider: 'weixin',
						success: function(loginRes) {
							console.log(loginRes);
							// _this.opengid(loginRes.code);
							_this.utils.getOpenId(loginRes.code,(res)=>{
								console.log(res);
								_this.wxpay(res.openid)
							})
						}
					});
				}
			},
			opengid(code) {
				console.log('code:'+code);
				this.http.getApi('user/getWxOpenid', {
					code: code
				}, 'get').then(res => {
					console.log(res);
					if (res.data) {
						// this.openId = res.data;
						// uni.setStorageSync('WXopenid', this.openId);
						// this.userLogin();
					} else {
						this.utils.error('登录失败！');
					}
				}).catch(err => {
					console.log(err);
					uni.hideLoading();
				});
			},
			//登录
			userLogin() {
				this.http.getApi('user/login', {
					openId: this.openId
				}, 'get').then(res => {
					console.log(res);
					this.userlist = res.data;
					uni.setStorageSync('userlist', this.userlist);
					this.panduan();
					if (this.userlist.usrLevel > 0) {
						this.Gvalueji();
					}
					this.utils.success('登录成功！');
					this.lognum = 1;
					uni.hideLoading();
				}).catch(err => {
					console.log(err);
					uni.hideLoading();
					if (err.status == 19) {
						// this.userRegister();
						var _this = this;
						this.utils.error('该用户未注册', () => {
							let li = {
								openId: _this.openId,
								usrName: _this.wxlist.nickName,
								spareOne: _this.wxlist.avatarUrl
							}
							uni.setStorageSync('wxlist', li);
							_this.doUrl('pages/user/register');

						});
					} else {
						this.utils.error(err.msg);
					}
				});
			},
			userRegister() {
				let li = {
					openId: this.openId,
					usrName: this.wxlist.nickName,
					spareOne: this.wxlist.avatarUrl
				}
				console.log(li)
				this.http.getApi('user/register', li, 'post').then(res => {
					console.log(res);
					this.userLogin();
					// uni.hideLoading();
				}).catch(err => {
					console.log(err);
					this.utils.error(err.msg);
					uni.hideLoading();
				});
			},
			YZdoUrl(item) { //跳转页面
				if (item.title == '在线客服') {
					this.callPhone(this.phone);
				} else {
					// this.doUrl(item.http);
					this.openMsg()
				}

			}
		}
	}
</script>

<style lang="scss">
	.bg_three {
		width: 100%;
		height: 200rpx;
		position: fixed;
		top: 0;
		z-index: -1;
		background-color: #F95D37;
		border-radius: 0 0 30rpx 30rpx;
	}

	.one_ck {
		margin-top: 40rpx;

		&_two {
			padding: 10rpx;
			border-radius: 0 0 15rpx 15rpx;
			background-color: #000000;
			color: #F95D37;
		}
	}
</style>
